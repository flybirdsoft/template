/*
write by wuweiwei(邬畏畏)
www.flybirdsoft.com/WUI
www.cnblogs.com/wsoft
www.github.com/flybirdsoft
*/
!function(e){var t={_startSymbol:"\\${",_endSymbol:"}",templateElement:{},contentNode:null};t.startSymbol=function(e){var t,i="",o="^$*+?{}[]|.";for(t=0;t<e.length;t++)o.indexOf(e.substr(t,1))>=0&&(i+="\\"),i+=e.substr(t,1);this._startSymbol=i},t.endSymbol=function(e){var t,i="",o="^$*+?{}[]|.";for(t=0;t<e.length;t++)o.indexOf(e.substr(t,1))>=0&&(i+="\\"),i+=e.substr(t,1);this._endSymbol=e},t.repeat=function(e){if(void 0==e.data)throw new Error("参数名称不对,参数是{},缺少data");if(void 0==e.repeatId&&void 0==e.repeatElement)throw new Error("参数名称不对,参数是{},缺少repeatElement或repeatId");var i,o,n,r,l,a,d,r,s,p,h={string:""},g=[],m=0,u=null,f=null,c=function(){},b={},y=null,v="";for(l=e.repeatElement||$(e.repeatId)[0],a=l.parentNode,(void 0==e.type||void 0!=e.type&&"cover"==e.type)&&t.deleteNode(l),void 0==e.template&&(e.template=l.innerHTML),void 0==e.data.length?(m=1,g[0]=e.data):(m=e.data.length,g=e.data),void 0!=e.count&&e.count<=m&&(m=e.count),void 0!=e.process&&(c=e.process||e.onprocess),u=l,f=a.lastChild,void 0!=e.onloadBefore&&e.onloadBefore.call(this),i=m-1;i>=0;i--){for(n=g[i],b={index:i,item:g[i]},d=c.call(this,b),y=document.createElement(l.nodeName),o=0;o<l.attributes.length;o++){v=l.attributes.item(o).value;for(r in d)s=this._startSymbol+r+this._endSymbol,p=new RegExp(s,"g"),v=v.replace(p,d[r]);for(r in n)s=this._startSymbol+r+this._endSymbol,p=new RegExp(s,"g"),v=v.replace(p,n[r]);y.setAttribute(l.attributes.item(o).name,v)}h.string=e.template;for(r in d)"object"!=typeof d[r]?(s=this._startSymbol+r+this._endSymbol,p=new RegExp(s,"g"),h.string=h.string.replace(p,d[r])):t.getScope(d,r,h);for(r in n)"object"!=typeof n[r]?(s=this._startSymbol+r+this._endSymbol,p=new RegExp(s,"g"),h.string=h.string.replace(p,n[r])):t.getScope(n,r,h);if(y.innerHTML=h.string,void 0!=e.type&&"append"==e.type){for(;null!=f&&(1!=f.nodeType||"templateItem"!=f.getAttribute("templateItem"));)f=f.previousSibling;a.insertBefore(y,f.nextSibling),y.style.display="",y.setAttribute("templateItem","templateItem"),y=f}else a.insertBefore(y,u.nextSibling),y.style.display="",y.setAttribute("templateItem","templateItem")}return l.style.display="none",void 0!=e.onload&&e.onload.call(this),void 0!=e.bind,new this.ModelView({data:e.data,target:l,parentNode:a})},t.getScope=function(e,t,i,o){var n,r,l="";if(r=e[t],"object"==typeof r){l=void 0==o?t:o;for(n in r){if(l+="."+n,"object"==typeof r[n])return void this.getScope(r,n,i,l);strV=this._startSymbol+l+this._endSymbol,reg=new RegExp(strV,"g"),i.string=i.string.replace(reg,r[n])}}},t.deleteNode=function(e){var t=e.nextSibling;if(null!=t){var i,o;try{o=1==t.nodeType&&"templateItem"==t.getAttribute("templateItem")||1!=t.nodeType}catch(n){return}for(;null!=t&&(i=t.nextSibling,o&&t.parentNode.removeChild(t),t=i,null!=t);)o=1==t.nodeType&&"templateItem"==t.getAttribute("templateItem")}},t.ModelView=function(e){this.data=e.data,this.parentNode=e.parentNode,this.target=e.target},t.ModelView.prototype.findNode=function(e){var t,i=0,o=!1,n=this.parentNode.childNodes,r=n.length;for(t=0;r>t;t++)if(this.target==n[t]&&(i=0,o=!0),1==n[t].nodeType&&i++,o&&i==e+2)return n[t];return null},t.ModelView.prototype.repeatToSingleNode=function(e,i){var o,n,r,l,a,d,s=this.target,p={string:""},h=this.row;for(p.string=s.innerHTML,o=void 0!=i&&i?document.createElement(s.nodeName):this.findNode(e),r=0;r<s.attributes.length;r++){l=s.attributes.item(r).value;for(n in h)d=t._startSymbol+n+t._endSymbol,a=new RegExp(d,"g"),l=l.replace(a,h[n]);o.setAttribute(s.attributes.item(r).name,l)}for(n in h)"object"!=typeof h[n]?(d=t._startSymbol+n+t._endSymbol,a=new RegExp(d,"g"),p.string=p.string.replace(a,h[n])):t.getScope(h,n,p);return o.innerHTML=p.string,o.style.display="",o},t.ModelView.prototype.doCondition=function(e){var t,i,o,n,r,l,a=this.data.length,d=this.data,s=!1,p=!1,h=-1;for(t in e){for(r=t.split("."),l=e[t],s=!1,p=!1,i=0;a>i;i++){for(n=d[i],o=0;o<r.length;o++)if(n=n[r[o]],void 0==n){s=!0;break}if(s)break;if(n==l){p=!0,h=i;break}p=!1}if(!p)break}return p?h:-1},t.ModelView.prototype.update=function(e,t,i){this.row=t;var o;o=this.doCondition(e),-1!=o&&(this.repeatToSingleNode(o),this.data[o]=t),i.call(this,-1==o?!1:!0)},t.ModelView.prototype["delete"]=function(e,t){var i,o;i=this.doCondition(e),o=this.findNode(i),o.parentNode.removeChild(o),this.data.splice(i,1),t.call(this)},t.ModelView.prototype.deleteIndex=function(e,t){var i;i=this.findNode(e),i.parentNode.removeChild(i),this.data.splice(e,1),void 0!=t&&t.call(this)},t.ModelView.prototype.add=function(e,t){var i,o=null;for(this.row=e,i=this.repeatToSingleNode(-1,!0),o=this.parentNode.lastChild;null!=o&&(1!=o.nodeType||"templateItem"!=o.getAttribute("templateItem"));)o=o.previousSibling;this.parentNode.insertBefore(i,o.nextSibling),this.data.push(e),void 0!=t&&t.call(this)},t.ModelView.prototype.insert=function(e,t,i){var o,n,r=null;for(this.row=t,o=this.repeatToSingleNode(-1,!0),r=this.target.nextSibling,n=0;e>n;n++)r=r.nextSibling;this.parentNode.insertBefore(o,r),this.data.splice(e,0,t),void 0!=i&&i.call(this)},t.ModelView.prototype.destroy=function(){this.data.length=0,this.parentNode=null,this.target=null},e.T=e.template=t}(window);